version: "3.8"

services:
  # Backend FastAPI + LangGraph Agent
  kitchen-backend:
    image: ghcr.io/alberth121484/kitchenmaster/backend:latest
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:${POSTGRES_PASSWORD}@kitchen-postgres:5432/kitchenmaster
      - REDIS_URL=redis://kitchen-redis:6379/0
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
      - REFRESH_TOKEN_EXPIRE_DAYS=7
      - CORS_ORIGINS=https://${FRONTEND_DOMAIN}
      - DEBUG=false
      - TZ=America/Mexico_City
    networks:
      - backend
      - automatlannetwork
    deploy:
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=automatlannetwork"
        - "traefik.http.routers.kitchen-api.rule=Host(`${API_DOMAIN}`)"
        - "traefik.http.routers.kitchen-api.entrypoints=websecure"
        - "traefik.http.routers.kitchen-api.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.kitchen-api.loadbalancer.server.port=8000"

  # Frontend Next.js
  kitchen-frontend:
    image: ghcr.io/alberth121484/kitchenmaster/frontend:latest
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=https://${API_DOMAIN}
        - NEXT_PUBLIC_WS_URL=wss://${API_DOMAIN}
    environment:
      - TZ=America/Mexico_City
    networks:
      - backend
      - automatlannetwork
    deploy:
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=automatlannetwork"
        - "traefik.http.routers.kitchen-web.rule=Host(`${FRONTEND_DOMAIN}`)"
        - "traefik.http.routers.kitchen-web.entrypoints=websecure"
        - "traefik.http.routers.kitchen-web.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.kitchen-web.loadbalancer.server.port=3000"

  # PostgreSQL Database con pgvector
  kitchen-postgres:
    image: pgvector/pgvector:pg16
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=kitchenmaster
      - TZ=America/Mexico_City
    volumes:
      - kitchen_postgres_data:/var/lib/postgresql/data
    networks:
      - backend
    deploy:
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # Redis Cache
  kitchen-redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    environment:
      - TZ=America/Mexico_City
    volumes:
      - kitchen_redis_data:/data
    networks:
      - backend
    deploy:
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

volumes:
  kitchen_postgres_data:
  kitchen_redis_data:

networks:
  backend:
    driver: overlay
    attachable: true
  automatlannetwork:
    external: true
    name: automatlannetwork